<script setup lang="ts">
import { Ref, ComputedRef } from "vue";
import { useFind, usePagination } from "feathers-pinia";
import { useUsers, User } from "~/stores/user";

useUsers();

const selectedClass = ref(null);
const search = ref("");

const current: Ref<User | null> = ref(null);
const setCurrent = (item: User) => (current.value = item);

const pagination = reactive({ $limit: 5, $skip: 0 });
const params = computed(() => {
  const nameFilter = { name: { $regex: search.value, $options: "igm" } };
  const classFilter = { class: selectedClass.value };

  return {
    query: {
      ...pagination,
      ...(selectedClass.value ? classFilter : null),
      ...nameFilter,
    },
    paginate: true,
  };
});
const { items, latestQuery } = useFind({
  model: User,
  params,
});
const users = items as ComputedRef<User[]>;
const { next, prev, canNext, canPrev, currentPage, pageCount, toPage } =
  usePagination(pagination, latestQuery);
</script>

<template>
  <div class="text-left">
    <div class="flex flex-row items-center space-x-1">
      <RowsPerPageSelector v-model:rows-per-page="pagination.$limit" />
      <ClassSelector v-model:school-class="selectedClass" />
      <TextInput
        v-model:value="search"
        label="Search by Name"
        placeholder="name"
      />
    </div>

    <!-- User Table -->
    <table class="table table-zebra w-130 mt-4">
      <thead>
        <tr>
          <th>Name</th>
          <th>Age</th>
          <th>Class</th>
        </tr>
      </thead>
      <tbody>
        <UserRow
          v-for="user in users"
          :key="user.id"
          :user="user"
          :class="{ active: user === current }"
          @click="() => setCurrent(user)"
        />
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="btn-group mt-4">
      <button
        class="btn"
        :class="{ 'opacity-50 cursor-not-allowed': !canPrev }"
        @click="canPrev && prev()"
      >
        Previous
      </button>
      <PaginationButton
        v-for="page in pageCount"
        :key="page"
        :page="page"
        :current-page="currentPage"
        @click="toPage(page)"
      />
      <button
        class="btn"
        :class="{ 'opacity-50 cursor-not-allowed': !canNext }"
        @click="canNext && next()"
      >
        Next
      </button>
    </div>
  </div>
</template>

<route lang="yaml">
meta:
  layout: home
</route>
